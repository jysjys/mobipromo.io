<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="icon" href="../assets/images/title.png" type="image/png" sizes="16x16">
<title>注册</title>
<meta name="keywords" content="" />
<meta name="description" content="" />
<link rel="stylesheet" href="/common/common.css">
<link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="../assets/css/login_register.css">
<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

</head>
<body>
	<div id="register-wrapper">
		<header>
			<img src="../assets/css/icon/logo_white.svg">
		</header>
		<form class="register_form">
			<h1>注冊</h1>
			<div class="inp">
				<input type="text" name="phone" class="phone" placeholder="手機號">
				<span class="phone_warn warn">格式不正確</span>
				<span class="phoneTwo_warn warn">用戶已經注冊</span>
				<span class="phoneThree_warn warn">發送頻率過快,請稍後重試</span>
			</div>
			<div class="inp">
				<input type="password" name="pwd" class="pwd" placeholder="請輸入密碼">
				<span class="pwd_warn warn">密碼不能爲空</span>
				<span class="pwd_warn_length warn">密碼長度必須是6到20位的字符，並且不能包含空格</span>
			</div>
			<div style="overflow: hidden;">
				<span>點擊確認注冊，即表示您已閱讀並同意<a href="../CAN用户服务协议.pdf" target="_blank"> CAN用戶協議</a></span>
			</div>
			<div>
				<button type="button" id="submit" class="btn">繼續</button>
			</div>
			<div>
				<span>已有賬戶？</span>
				<span><a href="./login.html">立即登錄</a></span>
			</div>
		</form>
		<form class="register_form_epid" style="display: none;">
			<h1>驗證手機號</h1>
			<div>
				<span>驗證碼已發送至您的手機號碼</span>
				<span>15110277440</span>
				<span><i></i>秒後可以重新發送</span>
			</div>
			<div class="inp">
				<input type="text" name="epid" class="epid" placeholder="請輸入驗證碼">
				<span class="epid_warn warn">驗證碼錯誤</span>
			</div>
			<div>
				<button type="button" id="verification" class="btn">驗證</button>
			</div>
		</form>
		<div id="footer"></div>
	</div>

	<script type="text/javascript" src="../assets/js/jquery.min.js"></script>
	<script type="text/javascript" src="../assets/js/util.js"></script>
	<script type="text/javascript" src="./load.js"></script>
	<script type="text/javascript" src="../assets/js/vue.min.js"></script>
	<script src="../assets/js/elementUiIndex.js"></script>
	<script type="text/javascript" src="/common/version1.0.js"></script>

	<script type="text/javascript">
		var vm = new Vue({
			el: '#register-wrapper',
		});
		var data = {};
		// 点击确认
		$("#submit").click(function () {
			warn()
		});

		// 点击验证
		$("#verification").on('click', function() {
			$('.warn').css('display', 'none')
			var epid = $("input[name = 'epid']").val().trim();
			data.epid = epid;
			console.log(data);
			$(this).loading();
			$.ajax({
			    type: 'POST',
			    url: '/promo/public/account',
			    data: {
			   		'code': epid,
			   		'phone': data.phone,
			   		'password': data.password
			    },
				success: function (res) {
					$('#verification').loading('close');
					if (res.code) {
						$('.epid_warn').css('display', 'inline-block')
						return;
					}
                    vm.$message({
                        message: '注冊成功',
                        type: 'success'
                    });
                    setTimeout(function () {
                        window.location.href="./login.html"
                    }, 3000)
				},
				error: function (res) {
					$('#verification').loading('close')
					console.log('fail')
					$('.epid_warn').css('display', 'inline-block')
				}
			})
		});


		// 表单验证
		function warn () {
            var isNullValidate = new RegExp("\\s")
			$(".warn").css({'display':'none'})
			var phone = $("input[name='phone']").val().trim(),
			password = $("input[name='pwd']").val().trim(),
			phone_number_reg = /^(((13[0-9]{1})|(15[0-9]{1})|(16[0-9]{1})|(17[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
			if(!phone_number_reg.test(phone)) {
				console.log('phone not empty')
				$(".phone_warn").css({'display':'inline-block'});
				return;
			} else if(!password) {
				console.log('password not empty')
				$(".pwd_warn").css({'display':'inline-block'});
				return;
			} else if(password.length < 6 || password.length > 20 || isNullValidate.test(password) === true) {
                $(".pwd_warn_length").css({'display':'inline-block'});
                return false;
			}
			data = {
				phone: phone,
				password: password
			};
			$("#submit").loading();
			$.ajax({
			   type: 'POST',
			   url: '/promo/register/sendcode',
			   data: {
			   	'account': data.phone
			   },
				success: function (res) {
					console.log('succ')
					console.log(res);
					$('#submit').loading('close')
					if(!res.code) {
						$('.register_form').remove();
						$('.register_form_epid').css('display', 'block');
						$('.register_form_epid div:eq(0) span:eq(1)').html(phone);
						countDown()
					} else if(res.code == '11001') {
						$('.phoneTwo_warn').css('display', 'inline-block')
						return;
					} else if(res.code == '11002') {
						$('.phoneThree_warn').css('display', 'inline-block')
						return;
					}
				},
				error: function (err, data) {
					console.log('fail')
					console.log(err, data);
					$("#submit").loading('close');
					return;
				}
			})
			console.log(data);
		}


		// 倒计时
		function countDown () {
			var time = 59;
			var t =	setInterval( function() {
				console.log('hello')
				if(time>1) {
					time -- ;
					$('.register_form_epid div:eq(0) span:eq(2)').loading().html(
						'<i>' + time + '</i>秒後可以重新發送'
						).css({
						'color': 'rgba(0,0,0,0.38)'
					});
					$('#vertication').attr('disabled', 'disabled');
				}else {
					clearInterval(t);
					time = 59;
					$('.register_form_epid div:eq(0) span:eq(2)').on('click', function() {
							sms();
							countDown();
							$(this).off('click');
					}).loading('close').html('重新發送').css({
						'color': '#1890FF',
						'cursor': 'pointer'
					});
					$('#vertication').removeAttr('disabled');
				}
			}, 1000);
		}

		
		// 短信验证码
		function sms () {
			$.ajax({
			   type: 'POST',
			   url: '/promo/register/sendcode',
			   data: {
			   	'account': data.phone
			   },
				success: function (res) {
					
				},
				error: function (err, data) {
					
				}
			})
		}
</script>
<style type="text/css">
	.warn {
		display: none;
	}
</style>
</body>
</html>