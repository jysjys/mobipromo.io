<!DOCTYPE html >
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="icon" href="assets/images/title.png" type="image/png" sizes="16x16">
	<title>mobipromo</title>
	<meta name="keywords" content="">
	<meta name="description" content="">
	<link rel="stylesheet" href="assets/css/login.css">
	<link rel="stylesheet" href="assets/css/icons/icons.css">
	<link rel="stylesheet" href="assets/css/presale.css">
	<style>
	.presale-container {
		padding-top: 100px;
	}
	</style>
</head>
<body>
	<a class="btn_coupon" href="./coupon.html">F码通道</a>
	<a class="btn_ver" href="">您已具备订购资格，点击购买！</a>
	<div class="presale-container">
		<h1>订单信息</h1>
	</div>

	<div class="dialog dialog-box" style="top:50px;left:300px;display: none;" id="upgrade_dlg">
		<h2 class="dialog-title">订单信息</h2>
		<div class="dlg-content">
			<div tit="1y" class="price ac">
				<div class="price-date">1 台</div>
				<div class="price-text">¥
					<label class="userprice">899</label>
				</div>
				<span class="icons">&#xe658;</span>
			</div>
			<div tit="2y" class="price">
				<div class="price-date">2 台</div>
				<div class="price-text">¥
					<label class="userprice">1798</label>
				</div>
				<span class="icons">&#xe658;</span>
			</div>
			<div tit="3y" class="price" alt="y3">
				<div class="price-date">3 台</div>
				<div class="price-text">¥
					<label class="userprice">2697</label>
				</div>
				<span class="icons">&#xe658;</span>
			</div>
			<div class="dlg-item">
				<!-- <div tit="wxpay" class="price-paytype ac">
					<span style="font-size:30px;color:#19c105;" class="icons">&#xe655;</span>
					<span class="icons ico">&#xe658;</span>
				</div> -->
				<div tit="alipay" class="price-paytype ac" style="padding:12px 5px 8px 5px;margin-left:12px;">
					<span style="font-size:24px;color:#00aaee;" class="icons">&#xe654;</span>
					<span class="icons ico">&#xe658;</span>
				</div>
			</div>
			<div class="dlg-item" style="text-align:right;margin-bottom:0;">
				<button id="zhifu" class="button">去支付 <label>¥ 899</label></button>
			</div>
		</div>
	</div>
	<div class="dialog dialog-box" style="top:50px;left:300px;display: none;" id="price_dlg">
		<h2 class="dialog-title">订单信息</h2>
		<div class="dlg-content">
			<div class="price ac" style="margin-right:0;">
				<div class="price-date">1 台</div>
				<div class="price-text">¥
					<label class="userprice">899</label>
				</div>
				<span class="icons">&#xe658;</span>
			</div>
			<div class="dlg-item">
				<!-- <div tit="wxpay" class="price-paytype ac">
					<span style="font-size:30px;color:#19c105;" class="icons">&#xe655;</span>
					<span class="icons ico">&#xe658;</span>
				</div> -->
				<div tit="alipay" class="price-paytype ac" style="padding:12px 5px 8px 5px;">
					<span style="font-size:24px;color:#00aaee;" class="icons">&#xe654;</span>
					<span class="icons ico">&#xe658;</span>
				</div>
			</div>
			<div class="dlg-item" style="text-align:right;margin-bottom:0;">
				<button id="zhifu2" class="button">去支付 <label>¥ 899</label></button>
			</div>
		</div>
	</div>

	<div id="commodList" class="trade-list">
		<ul class="loading" v-show="loading">
			<li>
				<span></span>
				<span></span>
				<span></span>
			</li>
		</ul>
		<ul v-for="(item, index) in list" v-show="!loading">
			<li @click="fade" class="clearfix">
				<label class="trade-time">{{ item.createdAt }}</label>
				<label class="trade-num">订单编号：{{ item.tradeNumber }}</label>
				<label>¥ {{ item.totalRmb }}</label>
				<span class="trade-open">
					<label class="title-status">{{ item.status == 'ok' ? '已付款' : item.status == 'cancel' ? '已取消' : item.status == 'close' ? '已关闭' : item.status == 'refund' ? '已退款' : '待付款' }}</label><i class='icons' style="color:#5C5162;font-size:12px;">&nbsp;&#xe73a;</i>
				</span>
  			</li>
			<li>
				<div>设备名称：{{ item.boxName }}</div>
				<div>用户名：{{ item.userName }}</div>
				<div>数量：{{ item.buyAmount }}</div>
				<div>收件地址：{{ item.receivingAddress }}</div>
				<div>联系电话：{{ item.userTel }}</div>
				<div>金额：{{ item.totalRmb }}</div>
				<div>状态：<a href="javascript:" class="link">{{ item.status == 'ok' ? '已付款' : item.status == 'cancel' ? '已取消' : item.status == 'close' ? '已关闭' : item.status == 'refund' ? '已退款' : '待付款' }}</a></div>
				<div class="operate" style="height: 35px;" v-if="item.status == 'wait'">
					<span style="margin-right:40px;" class="button default" @click="payagain(item, $event)">去付款</span>
					<span style="margin-right:10px;" class="button" @click="cancel(item, $event)">取&nbsp;&nbsp;&nbsp;&nbsp;消</span>
				</div>
			</li>
		</ul>
		<div></div>
		<div class="more_btn" @click='getList'>点击加载更多<i class="icons" style="color:#333; font-size: 12px;">&#xe73a;</i></div>
	</div>
	<div style="margin-top: 20px;margin-bottom: 100px;margin-left: 20%;margin-right: 20%;">
		<span style="text-align: left;display: inherit;">温馨提示：</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">1.每人仅限订购3台CAN星际宝盒。</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">2.您预先订购CAN星际宝盒需提前支付全款；</span>
		<!-- <span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">3.CAN星际宝盒的发货时间：在您订购的时间档内（12月23号20：00）按付款的先后顺序陆续安排在1月31号前发出；</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">4.请正确填写订购人姓名、联系方式、数量、收货地址等重要信息，确保您能及时收货。填写后请尽快提交订单，订单一旦提交将不可撤消；</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">5.订单生成后，只有支付成功的订单视为本次预售下单成功；</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">6.CAN星际宝盒发货费用由CAN官方承担；</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">7.为打击黄牛，收货信息将不可变更，请仔细确认您的收货信息，付款成功后将不可更改。由于收货信息填写错误造成您不能收货的，相关损失将由您本人承担；</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">8.CAN星际宝盒官方购买渠道：CAN星际宝盒官网；</span>
		<span style="font-size: 12px; line-height: 16px; color: #6f6d6d; margin-top: 10px; width: auto; display: block; text-align: left;">9.如有任何疑问联系微信客服，服务时间 09:00-21:00。</span> -->
	</div>
	<script src="assets/js/jquery.min.js"></script>
	<!-- <script src="assets/js/common.js"></script> -->
	<!--背景图片自动更换-->
	<script src="assets/js/supersized.3.2.7.min.js"></script>
	<!-- // <script src="assets/js/supersized-init.js"></script> -->
	<script src="assets/js/qrcode.js"></script>
	<script src="assets/js/address.js"></script>
	<script src="assets/js/vue.min.js"></script>
	<script srx='assets/js/util.js'></script>
	<!--表单验证-->
	<!-- <script src="assets/js/jquery.validate.min.js?var1.14.0"></script> -->
	<script>

	function getCookieValue(name) { /**获取cookie的值，根据cookie的键获取值**/
		//用处理字符串的方式查找到key对应value
		var name = escape(name);
		//读cookie属性，这将返回文档的所有cookie
		var allcookies = document.cookie;
		//查找名为name的cookie的开始位置
		name += "=";
		var pos = allcookies.indexOf(name);
		//如果找到了具有该名字的cookie，那么提取并使用它的值
		if (pos != -1) { //如果pos值为-1则说明搜索"version="失败
			var start = pos + name.length; //cookie值开始的位置
			var end = allcookies.indexOf(";", start); //从cookie值开始的位置起搜索第一个";"的位置,即cookie值结尾的位置
			if (end == -1) end = allcookies.length; //如果end值为-1说明cookie列表里只有一个cookie
			var value = allcookies.substring(start, end); //提取cookie的值
			return (value); //对它解码
		} else { //搜索失败，返回空字符串
			return "";
		}
	}
	var x = getCookieValue('Authorization');

	var commodList = new Vue({
		el: '#commodList',
		data: {
			list:[],
			curPage: 1,
			loading: true
		},
		mounted: function() {
			this.getList();
		},
		methods: {
			getList: function () {
				var isLoading = $('.more_btn').data('isLoading');
				if(isLoading) {
					return;
				}
				$('.more_btn').data('isLoading', true);
				var self = this;
				$.ajax({
					headers: {
						Accept: "application/json; charset=utf-8",
						Authorization: 'Bearer' + ' ' + x
					},
					type: 'POST',
					data: JSON.stringify({
						curPage: self.curPage
					}),
					contentType: "application/json; charset=utf-8",
					url: '/promo/authed/account/get/selllist',
					success: function(data) {
						self.loading = false;
						if(data.isOrdered.count != null) {
							$(".btn_ver").css({
								'display': 'block'
							}).attr('href', './activity/1.html')
							.text('您拥有 ' + data.isOrdered.count + ' 次购买资格，' + '已使用 ' + data.isOrdered.used + ' 次，' + '点击查看')
						}
						if(data.data.length == 0) {
							$('.more_btn').text('没有更多订单了！');
							return;
						}
						self.list = self.list.concat(data.data);
						if(data.data.length < 10) {
							$('.more_btn').text('没有更多订单了！');
							return;
						}
						self.curPage++;
						$('.more_btn').data('isLoading', false);
					},
					error: function (error) {
						if(error.responseJSON.error) {
							location.href = './indexlogin.html';
						}
					}
				})
			},
			fade: function(e) {
				var obj = $(e.target);
				if(obj.is('li'))
					$(e.target).next().slideToggle();
				else
					$(e.target).parents('li').next().slideToggle();
			},
			payagain: function (item) {
				$('#price_dlg').dialog();
				$('#price_dlg').find('.price-paytype').off('click').on('click', function(){
					$(this).addClass('ac').siblings('.price-paytype').removeClass('ac');
				});
				$('#price_dlg').find('.price-date').text(item.buyAmount + ' 台');
				$('#price_dlg').find('.userprice').text(item.totalRmb);
				$('#zhifu2').off('click').on('click', function(){
					//完成未支付
					var isLoading = $(this).data('isLoading');
					if(isLoading) {
						return;
					}
					$(this).data('isLoading', true);
					$.ajax({
						headers: {
							Accept: "application/json; charset=utf-8",
							Authorization: 'Bearer' + ' ' + x
						},
						url: '/promo/alipay/order/payagain',
						data: JSON.stringify({tradeNumber: item.tradeNumber}),
						type: 'POST',
						contentType: "application/json; charset=utf-8",
						success: function(data) {
							console.log(data)
							$(".dialog_warn2").css('display', 'none');
							if(data.not) {
								Util.globalTopTip("您填写的F码不存在", "top_error", 2000, $("#price_dlg"), !0);
							}else if(data.isUsed) {
								Util.globalTopTip("您填写的F码已使用过", "top_error", 2000, $("#price_dlg"), !0);
							}else if(data.isLocked) {
								Util.globalTopTip("您填写的F码已锁定", "top_error", 2000, $("#price_dlg"), !0);
							}
							else if(data.isFull) {
								Util.globalTopTip("您的代理商限购额度已满", "top_error", 2000, $("#price_dlg"), !0);
							}else if(data.isOut) {
								Util.globalTopTip("您的代理商限购额度已满", "top_error", 2000, $("#price_dlg"), !0);
							}else if(data.isSuccess) {
								location.href = data.httpurl;
							}else if(data.isNull) {
								//购买失败
								Util.globalTopTip("订单不存在", "top_error", 2000, $("#price_dlg"), !0);
							}
							$('#zhifu2').data('isLoading', false);
							console.log(data);
						},
						error: function(data) {
	 						if(data.responseJSON.error == 'invalid_token') {
								location.href = './indexlogin.html';
							}
							$('#zhifu2').data('isLoading', false);
							Util.globalTopTip("订单不存在", "top_error", 2000, $("#price_dlg"), !0);
						}
					});
				}).find('label').text('¥ ' + item.totalRmb);
			},
			cancel: function(item, e) {
				var isLoading = $(e.target).data('isLoading');
				if(isLoading) {
					return;
				}
				var self = this;
				$.confirm({
					content: "您将要取消订单<b>" + item.tradeNumber + "</b>, 是否继续？",
					onConfirm: function() {
					$.ajax({
						headers: {
							Accept: "application/json; charset=utf-8",
							Authorization: 'Bearer' + ' ' + x
						},
						type: 'POST',
						data: JSON.stringify({tradeNumber:item.tradeNumber}),
						contentType: "application/json; charset=utf-8",
						url: '/promo/alipay/order/cancel',
						success: function(data) {
							console.log(data)
							item.status = 'cancel';
						},
						error: function (data) {
							console.log(data);
							console.log('fail')
						}
					});
					}
				});
			}
		}
	});
	// getUserlist(1);

	var curPage = 1;
	$(".more_btn").on('click', function() {
		var isLoading = $(this).data('isLoading');
		if(isLoading) {
			return;
		}
		$(this).data('isLoading', true);
		getList();
		$(this).data('isLoading', false);
	});

	function btnPress(){
		$('.warn').remove();
		var boxName = $("input[name='device_name']").val().trim(),
			userName = $("input[name='username']").val().trim(),
			userTel = $("input[name='phone_number']").val().trim(),
			userEmail = $("input[name='mailbox']").val().trim(),
			userZipCode = $("input[name='zip_code']").val().trim(),
			addressProv = $('[name=address-level1]').val().trim(),
			addressCity = $('[name=address-level2]').val().trim(),
			addressCounty = $('[name=address-level3]').val().trim(),
			addressDetail = $("input[name='address-detail']").val().trim();
			// buyAmount = $("[name='buyAmount']").val().trim() * 1;
		var phone_number_reg = /^(((13[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1}))+\d{8})$/,
			email_reg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;
		var errorContent = $('<input>', {'class': 'warn'}),
			errorWarp = $('<div/>').append(errorContent);

		// var icoStartDate = new Date('2017/12/22 15:57:50');
		var currentdate = new Date();
		if (!boxName) {
			errorWarp.appendTo($("input[name='device_name']").parent());
			errorContent.val('设备名称不能为空');
			return;
		} else if (!userName) {
			errorWarp.appendTo($("input[name='username']").parent());
			errorContent.val('姓名不能为空');
			return;
		} else if (userName.length < 2 || userName.length > 20) {
			errorWarp.appendTo($("input[name='username']").parent());
			errorContent.val('姓名长度不合适');
			return;
		} else if (!userTel) {
			errorWarp.appendTo($("input[name='phone_number']").parent());
			errorContent.val('电话不能为空');
			return;
		} else if (!phone_number_reg.test(userTel)) {
			console.log('phone_number error');
			errorWarp.appendTo($("input[name='phone_number']").parent());
			errorContent.val('不是合法的手机号码');
			return;
		} else if (!userEmail) {
			errorWarp.appendTo($("input[name='mailbox']").parent());
			errorContent.val('邮箱不能为空');
			return;
		} else if (!email_reg.test(userEmail)) {
			console.log('email error');
			errorWarp.appendTo($("input[name='mailbox']").parent());
			errorContent.val('不是合法的邮箱');
			return;
		} else if (!userZipCode) {
			errorWarp.appendTo($("input[name='zip_code']").parent());
			errorContent.val('邮编不能为空');
			return;
		} else if (!addressProv || !addressCity) {
			errorWarp.appendTo($("[name='address-level1']").parent());
			errorContent.val('请选择省市');
			return;
		} else if (!addressDetail) {
			errorWarp.appendTo($("[name='address-detail']").parent());
			errorContent.val('请输入详细地址');
			return;
		}
		var address = [
			provice[addressProv].name,
			provice[addressProv]["city"][addressCity].name,
			provice[addressProv]["city"][addressCity].districtAndCounty[addressCounty],
			addressDetail
		].join(' ');
		jsonData = {
			boxName: $("input[name='device_name']").val(),
			userName: $("input[name='username']").val(),
			userTel: $("input[name='phone_number']").val(),
			userEmail: $("input[name='mailbox']").val(),
			userZipCode: $("input[name='zip_code']").val(),
			receivingAddress: address
		}
		$('#upgrade_dlg').dialog();
		$('#upgrade_dlg').find('.price').off('click').on('click', function(){
		$(this).addClass('ac').siblings('.price').removeClass('ac');
			$('#zhifu label').text('¥ ' + $(this).find('.userprice').text());
		});
		$('#upgrade_dlg').find('.price-paytype').off('click').on('click', function(){
			$(this).addClass('ac').siblings('.price-paytype').removeClass('ac');
		});
		$('#zhifu').off('click').on('click', function(){
			var isLoading = $(this).data('isLoading');
			if(isLoading) {
				return;
			}
			$(this).data('isLoading', true);
			jsonData.buyAmount = $('.price.ac').index() + 1;
			jsonData.totalRmb = jsonData.buyAmount * 899;
			jsonData.paymentType = $('.price-paytype.ac').attr('tit');
			$.ajax({
				headers: {
					Accept: "application/json; charset=utf-8",
					Authorization: 'Bearer' + ' ' + x
				},
				url: '/promo/authed/account/post/sell/msg',
				data: JSON.stringify(jsonData),
				type: 'POST',
				contentType: "application/json; charset=utf-8",
				success: function(data) {
					$('#zhifu').data('isLoading', false);
					if(data.isSuccess){
						location.href = data.httpurl;
					}else{
						//购买失败
						// getList(curPage);
					}
				},
				error: function(data) {
					$('#zhifu').data('isLoading', false);
					Util.globalTopTip(data.responseJSON.reason, "top_error", 2000, $("#upgrade_dlg"), !0);
				}
			});
		});
	};

    // 未开始
    var startTime = new Date('2017/12/23 20:00:00');
	var today = new Date();
	var toICO = Math.trunc((startTime.getTime()-today.getTime())/1000);
	// console.log(toICO)
	if(toICO>=0) {
		$("#submit").text('抢购尚未开始');
		$("#submit").css({
			'background': '#5C5162'
		});
		$("#submit").off('click');
	}else {
		$("#submit").text('确认信息');
		$("#submit").css({
			'background': '#458DEF'
		});
		$("#submit").on('click', function (){
			btnPress();
		});
	}
    function countDown(){
        // var startTime = new Date("2017/12/23,01:18:30");//开始时间
        var curTime = new Date();//当前时间
        var leftTime = parseInt((startTime.getTime() - curTime.getTime())/1000);//获得时间差
        //小时、分、秒需要取模运算
        var d = parseInt(leftTime/(60*60*24));
        var h = parseInt(leftTime/(60*60)%24);
        var m = parseInt(leftTime/60%60);
        var s = parseInt(leftTime%60);
        var ms = parseInt(((startTime.getTime() - curTime.getTime())/100)%10);
        if( d > 0 || h>0 || m  >10) {
         clearInterval(set);
         return;
        }
        m = (m + '').length == 1 ? ('0' + m) : m;
        s = (s + '').length == 1 ? ('0' + s) : s;
        ms = (ms + '').length == 1 ? ('0' + ms) : ms;
        var txt = "抢购即将开始："+m+":"+s+":"+ms;
        $("#submit").text(txt);
        if(leftTime<0){
        	$("#submit").text("确认信息").css({
				'background': '#458DEF'
			});
        	$("#submit").off('click').on('click', btnPress);
        	clearInterval(set);}
    };
	// var set = setInterval(countDown,100);
    // 结束
	var endTime = new Date('2017/12/23 20:08:00');//-10-05 12:00:00');
    var t = setInterval(function () {
    	var today = new Date();
    	var toICO = Math.trunc((endTime.getTime()-today.getTime())/1000);
    	// console.log(toICO)
    	if(toICO<=0) {
    		$("#submit").text('已经结束');
    		$("#submit").css({
    			'background': '#5C5162'
    		});
    		$("#submit").off('click');
    		clearInterval(t);
    	}
    }, 1000);

	$("[name='buyAmount']").on('change', function() {
		$("#jiage")[0].innerHTML = 899 * $(this).val();
	}).trigger('change');

	var jsonDate = {};

	var addrShow = $('#addr-show');
	var prov = $('#prov');
	var city = $('#city');
	var country = $('#country');

	/*用于保存当前所选的省市区*/
	var current = {
		prov: '',
		city: '',
		country: ''
	};

	/*自动加载省份列表*/
	(function showProv() {
		var len = provice.length;
		for (var i = 0; i < len; i++) {
			var provOpt = document.createElement('option');
			provOpt.innerText = provice[i]['name'];
			provOpt.value = i;
			prov.append(provOpt);
		}
	})();

	/*根据所选的省份来显示城市列表*/
	function showCity(obj) {
		var val = obj.options[obj.selectedIndex].value;
		if (val != current.prov) {
			current.prov = val;
			addrShow.val('');
		}
		//console.log(val);
		if (val != null) {
			city[0].length = 1;
			country[0].length = 1;
			var cityLen = provice[val]["city"].length;
			for (var j = 0; j < cityLen; j++) {
				var cityOpt = document.createElement('option');
				cityOpt.innerText = provice[val]["city"][j].name;
				cityOpt.value = j;
				city.append(cityOpt);
			}
		}
	}

	/*根据所选的城市来显示县区列表*/
	function showCounty(obj) {
		var val = obj.options[obj.selectedIndex].value;
		current.city = val;
		if (val != null) {
			country[0].length = 1; //清空之前的内容只留第一个默认选项
			var countryLen = provice[current.prov]["city"][val].districtAndCounty.length;
			if (countryLen == 0) {
				addrShow.val(provice[current.prov].name + '-' + provice[current.prov]["city"][current.city].name);
				return;
			}
			for (var n = 0; n < countryLen; n++) {
				var countyOpt = document.createElement('option');
				countyOpt.innerText = provice[current.prov]["city"][val].districtAndCounty[n];
				countyOpt.value = n;
				country.append(countyOpt);
			}
		}
	}
	</script>
</body>

</html>