<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="icon" href="../assets/images/title.png" type="image/png" sizes="16x16">
<title>注册</title>
<meta name="keywords" content="" />
<meta name="description" content="" />
<link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="../assets/css/login_register.css">
</head>
<body>
	<header>
		<img src="../assets/css/icon/logo.svg">
	</header>
	<form class="register_form">
		<h1>注册</h1>
		<div class="inp">
			<input type="text" name="phone" class="phone" placeholder="手机号">
			<span class="phone_warn warn">格式不正确</span>
			<span class="phoneTwo_warn warn">用户没有注册</span>
			<span class="phoneThree_warn warn">发送频率过快,请稍后重试</span>
		</div>
		<div class="inp">
			<input type="password" name="pwd" class="pwd" placeholder="请输入密码">
			<span class="pwd_warn warn">密码不能为空</span>
		</div>
		<div style="overflow: hidden;">
			<span>点击确认注册，即表示您已阅读并同意<a href=""> CAN用户协议</a></span>
		</div>
		<div>
			<button type="button" id="submit" class="btn">继续</button>
		</div>
		<div>
			<span>已有账户？</span>
			<span><a href="./login.html">立即登陆</a></span>
		</div>
	</form>
	<form class="register_form_epid" style="display: none;">
		<h1>验证手机号</h1>
		<div>
			<span>验证码已发送至您的手机号码</span>
			<span>15110277440</span>
			<span><i></i>秒后可以重新发送</span>
		</div>
		<div class="inp">
			<input type="text" name="epid" class="epid" placeholder="请输入验证码">
			<span class="epid_warn warn">验证码错误</span>
		</div>
		<div>
			<button type="button" id="verification" class="btn">验证</button>
		</div>
	</form>
	<footer>
		<div>
			<span>
				<img src="../assets/css/icon/ic_email_default.svg">
			</span>
			<span>
				<img src="../assets/css/icon/ic_qq_default.svg">
			</span>
			<span>
				<img src="../assets/css/icon/ic_wecaht_default.svg">
			</span>
		</div>
		<p>Copyright © 2017 MobiPromo Ltd.</p>
	</footer>
<script type="text/javascript" src="../assets/js/jquery.min.js"></script>
<script type="text/javascript" src="../assets/js/util.js"></script>
<script type="text/javascript">
		var data = {};
		// 点击确认
		$("#submit").click(function () {
			warn()
		});


		// 点击验证
		$("#verification").on('click', function() {
			$('.warn').css('display', 'none')
			var epid = $("input[name = 'epid']").val().trim();
			data.epid = epid;
			console.log(data);
			$(this).loading();
			$.ajax({
			    type: 'POST',
			    url: '/promo/public/account',
			    data: {
			   		'code': epid,
			   		'phone': data.phone,
			   		'password': data.password
			    },
				success: function (res) {
					$('#verification').loading('close');
					if (res.code) {
						$('.epid_warn').css('display', 'inline-block')
						return;
					}
					window.location.href="http://www.mobipromo.io/indexlogin.html"
				},
				error: function (res) {
					$('#verification').loading('close')
					console.log('fail')
					$('.epid_warn').css('display', 'inline-block')
				}
			})
		});


		// 表单验证
		function warn () {
			$(".warn").css({'display':'none'})
			var phone = $("input[name='phone']").val().trim(),
			password = $("input[name='pwd']").val().trim(),
			phone_number_reg = /^(((13[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
			if(!phone_number_reg.test(phone)) {
				console.log('phone not empty')
				$(".phone_warn").css({'display':'inline-block'});
				return;
			} else if(!password) {
				console.log('password not empty')
				$(".pwd_warn").css({'display':'inline-block'});
				return;
			}
			data = {
				phone: phone,
				password: password
			};
			$("#submit").loading();
			$.ajax({
			   type: 'POST',
			   url: '/promo/register/sendcode',
			   data: {
			   	'account': data.phone
			   },
				success: function (res) {
					console.log('succ')
					console.log(res);
					$('#submit').loading('close')
					if(!res.code) {
						$('.register_form').remove();
						$('.register_form_epid').css('display', 'block');
						$('.register_form_epid div:eq(0) span:eq(1)').html(phone);
						countDown()
					} else if(res.code == '11001') {
						$('.phoneTwo_warn').css('display', 'inline-block')
						return;
					} else if(res.code == '11002') {
						$('.phoneThree_warn').css('display', 'inline-block')
						return;
					}
				},
				error: function (err, data) {
					console.log('fail')
					console.log(err, data);
					$("#submit").loading('close');
					return;
				}
			})
			console.log(data);
		}


		// 倒计时
		function countDown () {
			var time = 5;
			var t =	setInterval( function() {
				console.log('hello')
				if(time>1) {
					time -- ;
					$('.register_form_epid div:eq(0) span:eq(2)').loading().html(
						'<i>' + time + '</i>秒后可以重新发送'
						).css({
						'color': 'rgba(0,0,0,0.38)'
					});
					$('#vertication').attr('disabled', 'disabled');
				}else {
					clearInterval(t);
					time = 5;
					$('.register_form_epid div:eq(0) span:eq(2)').on('click', function() {
							sms();
							countDown();
							$(this).off('click');
					}).loading('close').html('重新发送').css({
						'color': '#1890FF',
						'cursor': 'pointer'
					});
					$('#vertication').removeAttr('disabled');
				}
			}, 1000);
		}

		
		// 短信验证码
		function sms () {
			$.ajax({
			   type: 'POST',
			   url: '/promo/register/sendcode',
			   data: {
			   	'account': data.phone
			   },
				success: function (res) {
					
				},
				error: function (err, data) {
					
				}
			})
		}
</script>
<style type="text/css">
	.warn {
		display: none;
	}
</style>
</body>
</html>